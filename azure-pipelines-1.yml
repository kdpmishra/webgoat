trigger:
- master

variables:
  - group: DevSecOps-Secrets

pool:
  name: 'Default'   # change if your pool name is different

steps:
- checkout: self

- script: |
    echo "Successfully pulled WebGoat repo from GitHub"
    dir
  displayName: "Verify repo files"

# Download OWASP Dependency Check
- task: PowerShell@2
  displayName: "Download OWASP Dependency-Check"
  inputs:
    targetType: 'inline'
    script: |
      $zip = "$(Build.SourcesDirectory)\dependency-check.zip"
      Invoke-WebRequest -Uri "https://github.com/jeremylong/DependencyCheck/releases/download/v10.0.4/dependency-check-10.0.4-release.zip" -OutFile $zip
      Expand-Archive -LiteralPath $zip -DestinationPath "$(Build.SourcesDirectory)" -Force
      
      # Rename extracted folder
      Get-ChildItem "$(Build.SourcesDirectory)" -Directory |
        Where-Object { $_.Name -like "dependency-check*" } |
        Select-Object -First 1 |
        Rename-Item -NewName "dependency-check"

# Run OWASP Dependency Check
- task: PowerShell@2
  displayName: "Run OWASP Dependency Check"
  inputs:
    targetType: 'inline'
    script: |
      $scanPath = "$(Build.SourcesDirectory)"
      $outPath = "$(Build.SourcesDirectory)\sca-report"
      New-Item -ItemType Directory -Force -Path $outPath | Out-Null

      & "$(Build.SourcesDirectory)\dependency-check\bin\dependency-check.bat" `
        --project "WebGoat" `
        --scan "$scanPath" `
        --format "HTML" `
        --out "$outPath" `
        --validForHours 24 `
        --nvdApiKey "$(NVD_API_KEY)"   # ensure this exists in variable group

# Publish report
- task: PublishPipelineArtifact@1
  displayName: "Publish SCA report"
  inputs:
    targetPath: 'sca-report'
    artifact: 'sca-report'
    publishLocation: 'pipeline'
