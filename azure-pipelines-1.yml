trigger:
- master

pool:
  name: 'Default'  # adjust if your pool name is different
  
steps:

# 1) Fetch latest Trivy release URL and download
- task: PowerShell@2
  displayName: "Download latest Trivy"
  inputs:
    targetType: 'inline'
    script: |
      # Query GitHub API for latest release
      $apiUrl = 'https://api.github.com/repos/aquasecurity/trivy/releases/latest'
      $resp = Invoke-RestMethod -Uri $apiUrl -Headers @{ 'Accept' = 'application/vnd.github+json'; 'User-Agent' = 'azure-pipeline-script' }
      # Find Windows 64‑bit zip asset
      $asset = $resp.assets | Where-Object { $_.name -match 'windows-64bit.zip$' } | Select-Object -First 1
      if ($null -eq $asset) {
        throw "Cannot find Windows 64‑bit ZIP in latest Trivy release assets"
      }
      $downloadUrl = $asset.browser_download_url
      Write-Host "Downloading Trivy from $downloadUrl"

      $zipPath = Join-Path "$(Build.SourcesDirectory)" 'trivy.zip'
      Invoke-WebRequest -Uri $downloadUrl -OutFile $zipPath -UseBasicParsing

      # Extract
      Expand-Archive -LiteralPath $zipPath -DestinationPath "$(Build.SourcesDirectory)" -Force
      # Find extracted folder
      $trivyFolder = Get-ChildItem "$(Build.SourcesDirectory)" -Directory | Where-Object { $_.Name -match 'trivy' } | Select-Object -First 1
      if ($null -eq $trivyFolder) { throw "Trivy folder not found after extraction" }

      $trivyExe = Join-Path $trivyFolder.FullName 'trivy.exe'
      if (!(Test-Path $trivyExe)) { throw "trivy.exe not found: $trivyExe" }

      Write-Host "Trivy executable: $trivyExe"
      Write-Host "##vso[task.setvariable variable=TRIVY_EXE]$trivyExe"

# 2) Run Trivy filesystem scan for your repo
- task: PowerShell@2
  displayName: "Run Trivy Scan"
  inputs:
    targetType: 'inline'
    script: |
      $trivy = "$(TRIVY_EXE)"
      $scanPath = "$(Build.SourcesDirectory)"
      $reportDir = Join-Path "$(Build.SourcesDirectory)" 'trivy-report'
      New-Item -ItemType Directory -Force -Path $reportDir | Out-Null

      Write-Host "Scanning: $scanPath"
      & $trivy fs `
        --format template `
        --template "@contrib/html.tpl" `
        --output (Join-Path $reportDir 'report.html') `
        --severity CRITICAL,HIGH,MEDIUM `
        $scanPath

      & $trivy fs `
        --format json `
        --output (Join-Path $reportDir 'report.json') `
        --severity CRITICAL,HIGH,MEDIUM `
        $scanPath

      Write-Host "Reports generated at: $reportDir"

# 3) Publish report artifact
- task: PublishBuildArtifacts@1
  displayName: "Publish Trivy Report"
  inputs:
    pathToPublish: '$(Build.SourcesDirectory)/trivy-report'
    artifactName: 'trivy-report'
