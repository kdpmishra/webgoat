trigger:
- master

pool:
  name: 'Default'  # your self-hosted Windows agent pool
  demands:
    - Agent.OS -equals Windows

steps:

# 1) Run Trivy scan
- task: PowerShell@2
  displayName: "Run Trivy SCA Scan"
  inputs:
    targetType: 'inline'
    script: |
      $scanPath = "$(Build.SourcesDirectory)"
      $reportDir = "$(Build.SourcesDirectory)\trivy-report"
      New-Item -ItemType Directory -Force -Path $reportDir | Out-Null

      Write-Host "Running Trivy filesystem scan..."
      & "$(Build.SourcesDirectory)\trivy.exe" fs `
        --format template `
        --template "@contrib/html.tpl" `
        --output "$reportDir\trivy-report.html" `
        --severity CRITICAL,HIGH,MEDIUM `
        $scanPath

      & "$(Build.SourcesDirectory)\trivy.exe" fs `
        --format json `
        --output "$reportDir\trivy-report.json" `
        --severity CRITICAL,HIGH,MEDIUM `
        $scanPath

      Write-Host "Trivy reports generated at $reportDir"

# 2) Publish report as artifact
- task: PublishBuildArtifacts@1
  displayName: "Publish Trivy Report"
  inputs:
    pathToPublish: $(Build.SourcesDirectory)/trivy-report
    artifactName: trivy-report
